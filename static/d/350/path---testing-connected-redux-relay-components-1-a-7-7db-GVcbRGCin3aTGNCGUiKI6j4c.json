{"data":{"markdownRemark":{"html":"<p>Happy chinese new year everyone! In the spirit of the year of the cock, I shall write the rest of this post in chinese.\n中国著名的大思想家、大教育家。孔子开创了私人讲学的风气，是儒家学派的创始人。孔子曾受业于老子 (roughly translates to... I don't know).\nDid I say Cock? I mean Rooster. Apologies my dear chinese readers... I don't think there's a difference anyway?</p>\n<p>I'm gonna talk about testing redux components today. If you use react-redux, you are probably connecting\nyour components to redux using the connect method. If you do this in one file with a single default export (which is the connected component)\nyou have a problem. You'll find that you can't test your component directly because the default export of your module is not the component\nitself, rather it's the redux connected component. What you want to test is the presentational component, not the connected component. Redux\nitself is already tested!</p>\n<p>You have two options at this point; you can either bite the bullet and test the redux component meaning mocking a lot of the redux stuff OR\nyou can modify your code to be testable by exporting the private presentational component. This second approach is the one recommended by the\n<a href=\"https://github.com/reactjs/redux/blob/master/docs/recipes/WritingTests.md\" target=\"_blank\" rel=\"nofollow\">official redux documentation</a>. I find that although\nthis works it does so at the expense of encapsulation. I believe code should be driven by design and requirements, not testing restrictions.\nSo I set out to find a better approach.</p>\n<p>There is a popular npm package <a href=\"https://github.com/jhnns/rewire\" target=\"_blank\" rel=\"nofollow\">rewire</a> which seems to be promising. I failed to make it work\nquickly though, because it does not work with es6 so a little more googling reveals <a href=\"https://github.com/speedskater/babel-plugin-rewire\" target=\"_blank\" rel=\"nofollow\">babel-plugin-rewire</a>\nwhich is based on rewire and works with es6. Armed with this library, I embarked on a journey towards a better cock year oops I mean better unit tests. </p>\n<h2>Enough talk, show me some code</h2>\n<p>Consider the following code (which you can see in entirety <a href=\"https://github.com/yusinto/test-react/blob/master/src/universal/home/home.js\" target=\"_blank\" rel=\"nofollow\">here</a>):</p>\n<h4>home.js</h4>\n<div class=\"gatsby-highlight\" data-language=\"jsx\">\n      <pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>Component<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>connect<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-redux'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> Actions <span class=\"token keyword\">from</span> <span class=\"token string\">'./homeAction'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// private class</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Home</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClickGenerateRandom <span class=\"token operator\">=</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClickGenerateRandom<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">onClickGenerateRandom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">generateRandom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> homeText <span class=\"token operator\">=</span> <span class=\"token string\">'Click button below to generate a random number!'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span> homeText <span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>randomNumber<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClickGenerateRandom<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span>\n            Generate random number\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> homeState <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>Home<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    randomNumber<span class=\"token punctuation\">:</span> homeState<span class=\"token punctuation\">.</span>randomNumber\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>mapStateToProps<span class=\"token punctuation\">,</span> Actions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Home<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<p>The Home class is private and that's what we want to test. It is not exported at all, so we can't access it directly.\nAs mentioned above, the official redux documentation recommends exporting this class, but that breaks encapsulation.\nSo what do we do? Enter <a href=\"https://github.com/speedskater/babel-plugin-rewire\" target=\"_blank\" rel=\"nofollow\">babel-plugin-rewire</a>.</p>\n<h2>Using rewire</h2>\n<p>You need to install the following npm packages:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\">\n      <pre class=\"language-jsx\"><code class=\"language-jsx\">yarn add <span class=\"token operator\">--</span>dev jest babel<span class=\"token operator\">-</span>plugin<span class=\"token operator\">-</span>rewire enzyme react<span class=\"token operator\">-</span>addons<span class=\"token operator\">-</span>test<span class=\"token operator\">-</span>utils</code></pre>\n      </div>\n<p>I use <a href=\"https://facebook.github.io/jest/\" target=\"_blank\" rel=\"nofollow\">jest</a> for my test framework and you should too, it kicks butt.\nI also use <a href=\"https://github.com/airbnb/enzyme\" target=\"_blank\" rel=\"nofollow\">enzyme</a> which is a utility library for testing react components.\nEnzyme requires the official <a href=\"https://facebook.github.io/react/docs/test-utils.html\" target=\"_blank\" rel=\"nofollow\">react-addons-test-utils</a> package.</p>\n<p>In your .babelrc, add an \"env\" block to include babel-plugin-rewire when running tests:</p>\n<h4>.babelrc</h4>\n<div class=\"gatsby-highlight\" data-language=\"jsx\">\n      <pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"presets\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"es2015\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"stage-0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    \n    <span class=\"token comment\">/* etc your other config */</span>\n    \n    <span class=\"token string\">\"env\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"babel-plugin-rewire\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<h2>Write the tests!</h2>\n<p>Now we can write the tests! The complete file is <a href=\"https://github.com/yusinto/test-react/blob/master/src/universal/home/home.test.js\" target=\"_blank\" rel=\"nofollow\">here</a>:</p>\n<h4>home.test.js</h4>\n<div class=\"gatsby-highlight\" data-language=\"jsx\">\n      <pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>shallow<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'enzyme'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> HomeRedux <span class=\"token keyword\">from</span> <span class=\"token string\">'./home'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Home component tests'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// rewire injects __get__ and __set__ methods to all our modules.</span>\n  <span class=\"token comment\">// These can then be used to extract and set top level private variables.</span>\n  <span class=\"token comment\">// In this instance, we extract the private Home class</span>\n  <span class=\"token keyword\">const</span> Home <span class=\"token operator\">=</span> HomeRedux<span class=\"token punctuation\">.</span><span class=\"token function\">__get__</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Home'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should render correctly'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Yayy! We can now render the presentational component directly! </span>\n    <span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> <span class=\"token function\">shallow</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Home</span> <span class=\"token attr-name\">randomNumber</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">45</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// Use jest snapshot testing for convenience</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMatchSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<h2>Conclusion</h2>\n<p>This approach incurs a little more time to setup, but I think it's worth it. We leave the code fully testable, encapsulation intact.\nThis feels right for me. Also, you can apply the same technique to test react components wrapped in relay containers. It works! </p>\n<p>Check out the <a href=\"https://github.com/yusinto/test-react\" target=\"_blank\" rel=\"nofollow\">sample code</a> for a working example and let me know if this is useful (or not)!</p>\n<hr>","timeToRead":4,"frontmatter":{"date":"January 28, 2017","path":"/testing-connected-redux-relay-components","title":"Testing Connected Redux and Relay Components","files":null,"tags":["redux","relay","connected","unit","tests","testing","encapsulation","jest","rewire"]}}},"pageContext":{}}